{% extends 'miepi/base.html' %}
{% load static %}

{% block title %}Calendario de Cursos{% endblock %}
{% block header_title %}Gestión de Cursos y Calendario{% endblock %}

{% block content %}
<!-- Contenedor Principal -->
<div class="max-w-7xl mx-auto">
    
    <!-- Encabezado y Botón -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0 drop-shadow-sm">Calendario de Cursos</h2>
        <button onclick="abrirModalCrear()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-lg hover:shadow-xl flex items-center transition-all transform hover:-translate-y-0.5">
            <i class="fa-solid fa-plus mr-2"></i> Nuevo Curso
        </button>
    </div>

    <!-- Contenedor de Alertas (Mensajes) -->
    <div id="alert-container" class="mb-4">
        {% if messages %}
            {% for message in messages %}
                <div class="p-4 mb-4 text-sm rounded-lg shadow-sm border backdrop-blur-sm {% if message.tags == 'error' %}bg-red-100/90 border-red-200 text-red-700{% else %}bg-green-100/90 border-green-200 text-green-700{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Calendario Container -->
    <!-- EFECTO CRISTAL: bg-white/90 y backdrop-blur -->
    <div class="bg-white/80 backdrop-blur-md p-6 rounded-xl shadow-xl border border-white/50">
        <div id="calendar"></div>
    </div>
</div>

<!-- MODAL (Tailwind CSS) -->
<div id="modalCurso" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay de fondo (oscuro con blur) -->
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" aria-hidden="true" onclick="cerrarModal()"></div>

    <!-- Contenido del Modal -->
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-200">
            
            <!-- Header Modal -->
            <div class="bg-gray-50 px-4 pb-4 pt-5 sm:p-6 sm:pb-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold leading-6 text-gray-900" id="modalCursoTitle">Nuevo Curso</h3>
            </div>

            <!-- Body Modal -->
            <div class="px-4 py-6">
                <form id="formCurso">
                    {% csrf_token %}
                    <input type="hidden" id="curso_id" name="curso_id">
                    
                    <div class="mb-5">
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Curso *</label>
                        <input type="text" id="nombre" name="nombre" required
                            class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-50 focus:bg-white transition-colors">
                        <p class="mt-1 text-xs text-red-600 hidden" id="error_nombre"></p>
                    </div>
                    
                    <div class="mb-5">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción *</label>
                        <textarea id="descripcion" name="descripcion" rows="3" required
                            class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-50 focus:bg-white transition-colors"></textarea>
                        <p class="mt-1 text-xs text-red-600 hidden" id="error_descripcion"></p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="fecha_inicio" class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio *</label>
                            <input type="date" id="fecha_inicio" name="fecha_inicio" required
                                class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-50 focus:bg-white">
                            <p class="mt-1 text-xs text-red-600 hidden" id="error_fecha_inicio"></p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="fecha_fin" class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin *</label>
                            <input type="date" id="fecha_fin" name="fecha_fin" required
                                class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-gray-50 focus:bg-white">
                            <p class="mt-1 text-xs text-red-600 hidden" id="error_fecha_fin"></p>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer Modal -->
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-200">
                <button type="button" onclick="guardarCurso()"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-colors">
                    <i class="fas fa-save mr-2 mt-1"></i> Guardar
                </button>
                
                <button type="button" id="btnEliminar" onclick="eliminarCurso()" style="display: none;"
                    class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto transition-colors">
                    <i class="fas fa-trash mr-2 mt-1"></i> Eliminar
                </button>

                <button type="button" onclick="cerrarModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-100 sm:mt-0 sm:w-auto transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS ESPECÍFICOS -->
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    let calendar;
    let modoEdicion = false;
    let cursoActualId = null;

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            themeSystem: 'standard', 
            height: 'auto', // Ajuste de altura
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                list: 'Lista'
            },
            // Asegúrate de que esta URL exista en tu urls.py
            events: '{% url "miepi:cursos_json" %}', 
            eventClick: function(info) {
                abrirModalEditar(info.event.id);
            },
            dateClick: function(info) {
                abrirModalCrear(info.dateStr);
            },
            eventDidMount: function(info) {
                info.el.style.cursor = 'pointer';
                // Estilo simple para los eventos
                info.el.style.borderColor = 'transparent';
            }
        });
        
        calendar.render();
    });

    // --- LÓGICA DEL MODAL ---
    
    function abrirModal() {
        document.getElementById('modalCurso').classList.remove('hidden');
    }

    function cerrarModal() {
        document.getElementById('modalCurso').classList.add('hidden');
        limpiarErrores();
    }

    function abrirModalCrear(fecha = null) {
        modoEdicion = false;
        cursoActualId = null;
        
        document.getElementById('modalCursoTitle').textContent = 'Nuevo Curso';
        document.getElementById('formCurso').reset();
        document.getElementById('curso_id').value = '';
        document.getElementById('btnEliminar').style.display = 'none';
        
        if (fecha) {
            document.getElementById('fecha_inicio').value = fecha;
        }
        
        limpiarErrores();
        abrirModal();
    }

    function abrirModalEditar(cursoId) {
        modoEdicion = true;
        cursoActualId = cursoId;
        
        document.getElementById('modalCursoTitle').textContent = 'Editar Curso';
        document.getElementById('btnEliminar').style.display = 'inline-flex';
        
        fetch(`/cursos/api/${cursoId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('curso_id').value = data.id;
                document.getElementById('nombre').value = data.nombre;
                document.getElementById('descripcion').value = data.descripcion;
                document.getElementById('fecha_inicio').value = data.fecha_inicio;
                document.getElementById('fecha_fin').value = data.fecha_fin;
                
                abrirModal();
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error al cargar el curso', 'error');
            });
    }

    function guardarCurso() {
        const formData = new FormData(document.getElementById('formCurso'));
        const url = modoEdicion 
            ? `/cursos/api/${cursoActualId}/editar/`
            : '/cursos/api/crear/';
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarMensaje(data.message, 'success');
                calendar.refetchEvents();
                cerrarModal();
            } else {
                mostrarErrores(data.errors);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error al guardar el curso', 'error');
        });
    }

    function eliminarCurso() {
        if (!confirm('¿Estás seguro de eliminar este curso?')) {
            return;
        }
        
        fetch(`/cursos/api/${cursoActualId}/eliminar/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarMensaje(data.message, 'success');
                calendar.refetchEvents();
                cerrarModal();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error al eliminar el curso', 'error');
        });
    }

    // --- MANEJO DE ERRORES Y MENSAJES ---

    function mostrarErrores(errors) {
        limpiarErrores();
        for (const [field, messages] of Object.entries(errors)) {
            const input = document.getElementById(field);
            const errorP = document.getElementById(`error_${field}`);
            
            if (input && errorP) {
                input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                errorP.textContent = messages.join(', ');
                errorP.classList.remove('hidden');
            }
        }
    }

    function limpiarErrores() {
        document.querySelectorAll('input, textarea').forEach(el => {
            el.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        });
        document.querySelectorAll('[id^="error_"]').forEach(el => {
            el.classList.add('hidden');
            el.textContent = '';
        });
    }

    function mostrarMensaje(mensaje, tipo) {
        const colorClass = tipo === 'error' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-green-100 text-green-700 border-green-200';
        
        const alertHTML = `
            <div class="p-4 mb-4 text-sm rounded-lg border shadow-sm ${colorClass} transition-opacity duration-500 flex items-center" role="alert">
                <i class="fa-solid ${tipo === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check'} mr-2"></i>
                ${mensaje}
            </div>
        `;
        
        const container = document.getElementById('alert-container');
        container.innerHTML = alertHTML;
        
        setTimeout(() => {
            const alertDiv = container.firstElementChild;
            if (alertDiv) {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500);
            }
        }, 5000);
    }
</script>
{% endblock %}