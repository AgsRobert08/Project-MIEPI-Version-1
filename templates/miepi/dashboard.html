{% extends 'miepi/base.html' %}

{% block title %}Inscripción{% endblock %}
{% block header_title %}Registro{% endblock %}

{% block content %}
<div class="container">
  <section id="registro" class="form-card">
    <form id="form">
      <div>
          <label>Nombre Completo</label>
          <input type="text" id="nombre" required>
      </div>
      <div>
          <label>Sub Zona</label>
          <input type="text" id="subzona" required>
      </div>
      <div>
          <label>Teléfono</label>
          <input type="tel" id="telefono" required>
      </div>
      <div>
          <label>Grado Eclesiástico</label>
          <input type="text" id="grado" required>
      </div>
      <div>
          <label>Periodo de pago</label>
          <select id="periodo" required>
              <option value="">Seleccione</option> 
              <option value="07 Ene - 21 Feb|1500">07 Ene - 21 Feb $1500</option>
              <option value="22 Feb - 31 Mar|1700">22 Feb - 31 Mar $1700</option>
              <option value="31 Mar - 26 Abr|1900">31 Mar - 26 Abr $1900</option>
          </select>
      </div>
      <div class="submit-container">
          <button type="submit">Registrar</button>
      </div>
    </form>
  </section>

  <section id="inscritos">
    <h1>Lista de Inscritos</h1>
    <div class="table-responsive">
      <table>
          <thead>
              <tr>
                  <th>Nombre Completo</th>
                  <th>Sub zona</th>
                  <th>Teléfono</th>
                  <th>Grado Eclesiástico</th>
                  <th>Periodo de Pago</th>
                  <th>QR</th>
              </tr>
          </thead>
          <tbody id="tabla"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="popup" class="popup"></div>

<style>
/* FORMULARIO */
.form-card {
    background: #ffffff6f;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* Inputs y Botones */
form { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 16px; 
}
label { font-size: 14px; color: #444; }
input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 4px; }
button { 
    padding: 10px; 
    border: none; 
    border-radius: 10px; 
    background: #52658c; 
    color: #fff; 
    font-size: 16px; 
    cursor: pointer; 
}
button:hover { background: #5b83a5; }
button:focus { outline: none; }
.submit-container { grid-column: 1 / -1; text-align: center; margin-top: 10px; }

/* Tabla */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; min-width: 600px; }
th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; font-size: 14px; }
th { background: #eaeaeab9; }
.qr-container { margin-top: 10px; text-align: center; }
.qr-button { background: #4aa3f0; font-size: 13px; padding: 6px 10px; margin-top: 4px; border-radius: 5px; cursor:pointer; color:#fff; border:none; }
.qr-button:hover { background: #3780c0; }

/* Popup */
.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: #ff6b6b;
    color: #fff;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 9999;
    font-size: 16px;
    text-align: center;
    max-width: 300px;
}
.popup.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

/* MODO OSCURO */
.dark .form-card {
    background: var(--bg-card, #1e1e1e9f);
    color: var(--text-main, #e5e5e5);
}
.dark label { color: var(--text-main, #e5e5e5); }
.dark input, .dark select { background: #1e1e1e; color: #e5e5e5; border-color: var(--border-main, #444); }
.dark select option { background: #1e1e1e; color: #e5e5e5; }
.dark table { background: transparent; }
.dark th, .dark td { color: var(--text-main, #e5e5e5); border-bottom: 1px solid var(--border-main, #444); }
.dark th { background: rgba(255, 255, 255, 0.06); }
.dark .popup { color: #fff; }

/* === CORRECCIÓN ICONO HEADER (SIN FONDO) === */
header .profile button{
    background: none !important;
    padding: 0 !important;
    border-radius: 0 !important;
}

header .profile button i{
    background: none !important;
    color: var(--text-main) !important;
    font-size: 22px;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    form { grid-template-columns: 1fr; }
    table { font-size: 13px; min-width: 500px; }
}
@media (max-width: 480px) {
    table { font-size: 12px; min-width: 400px; }
    .qr-button { font-size: 11px; padding: 5px 8px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
const form = document.getElementById('form');
const tabla = document.getElementById('tabla');
const popup = document.getElementById('popup');
const inscritos = [];

function showPopup(msg, color="#ff6b6b"){
    popup.textContent = msg;
    popup.style.background = color;
    popup.classList.add('show');
    setTimeout(() => popup.classList.remove('show'), 1000);
}

form.addEventListener('submit', function(e) {
    e.preventDefault();

    const nombre = document.getElementById('nombre').value.trim();
    const subzona = document.getElementById('subzona').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const grado = document.getElementById('grado').value.trim();
    const periodoMonto = document.getElementById('periodo').value;

    if(!nombre || !subzona || !telefono || !grado || !periodoMonto){
        showPopup("Todos los campos obligatorios deben llenarse");
        return;
    }

    if(inscritos.some(p => p.nombre.toLowerCase() === nombre.toLowerCase())){
        showPopup("Ya existe un registro con el mismo nombre");
        form.reset();
        return;
    }

    if(inscritos.some(p => p.telefono === telefono)){
        showPopup("Ya existe un registro con el mismo número de teléfono");
        form.reset();
        return;
    }

    inscritos.push({nombre, telefono});

    const [periodo, monto] = periodoMonto.split('|');

    const fila = document.createElement('tr');
    const qrCell = document.createElement('td');
    const qrDiv = document.createElement('div');
    qrDiv.classList.add('qr-container');

    const qrButton = document.createElement('button');
    qrButton.classList.add('qr-button');
    qrButton.textContent = 'Ver QR';
    qrButton.onclick = () => {
        qrDiv.innerHTML = '';
        const qr = new QRCode(qrDiv, {
            text: `Nombre: ${nombre}\nSub zona: ${subzona}\nTel: ${telefono}\nGrado: ${grado}\nPeriodo: ${periodo}`,
            width: 100,
            height: 100
        });
    };

    qrDiv.appendChild(qrButton);
    qrCell.appendChild(qrDiv);

    fila.innerHTML = `<td>${nombre}</td><td>${subzona}</td><td>${telefono}</td><td>${grado}</td><td>${periodo}</td>`;
    fila.appendChild(qrCell);
    tabla.appendChild(fila);

    form.reset();
    showPopup("Inscripción realizada con éxito!", "#4aa3f0");
});
</script>
{% endblock %}
