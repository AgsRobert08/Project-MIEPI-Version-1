{% extends 'miepi/base.html' %}

{% block title %}Asistencias{% endblock %}

{% block content %}
<div class="asistencias-header">
    <h2>‚úì Lista de Asistencias</h2>

    <a href="{% url 'miepi:asistencias_pdf' %}?{{ request.GET.urlencode }}"
       class="btn-export-pdf">
        üìÑ Exportar PDF
    </a>
</div>



<!-- BUSCADOR PERSONALIZADO -->
<div class="card" style="margin-bottom:20px">
    <h4>Buscar asistente</h4>
    <input id="searchInput" type="text" placeholder="Buscar por nombre o tel√©fono..."
           style="width:100%;padding:14px;border-radius:12px;
           border:1px solid var(--border-main);
           background:transparent;color:var(--text-main);
           margin-top:12px">
    <div id="searchResults"></div>
</div>



<!-- FILTRO POR G√âNERO -->
<div class="filtro-toggle" style="margin-bottom:20px;">
    <label class="toggle-switch">
        <input type="radio" name="filtro_genero" value=""
               {% if not request.GET.genero %}checked{% endif %}
               onchange="filtrarGenero('')">
        <span class="slider"></span><span class="label-text">Todos</span>
    </label>

    <label class="toggle-switch">
        <input type="radio" name="filtro_genero" value="Masculino"
               {% if request.GET.genero == 'Masculino' %}checked{% endif %}
               onchange="filtrarGenero('Masculino')">
        <span class="slider"></span><span class="label-text">Masculino</span>
    </label>

    <label class="toggle-switch">
        <input type="radio" name="filtro_genero" value="Femenino"
               {% if request.GET.genero == 'Femenino' %}checked{% endif %}
               onchange="filtrarGenero('Femenino')">
        <span class="slider"></span><span class="label-text">Femenino</span>
    </label>
</div>

<!-- TABLA DATATABLE RESPONSIVE -->
<div class="table-responsive">
    <table id="asistenciasTable" class="display nowrap asistencias-table" style="width:100%;">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>D√≠a</th>
                <th>Hora</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for a in asistencias %}
            <tr>
                <td>{{ a.inscrito.nombre }}</td>
                <td>{{ a.fecha|date:"l" }}</td>
                <td>{{ a.hora }}</td>
                <td style="color:green;font-weight:bold;">Presente</td>
                <td>
                    <form method="post"
                          action="{% url 'miepi:eliminar_asistencia' a.id %}"
                          class="swal-delete"
                          data-nombre="{{ a.inscrito.nombre }}">
                        {% csrf_token %}
                        <button type="submit" class="action-btn delete">üóëÔ∏è</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align:center;padding:15px;">
                    No hay asistencias registradas
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
/* Toggle switch */
.filtro-toggle { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-bottom:20px;}
.toggle-switch { display:flex; align-items:center; cursor:pointer; }
.toggle-switch input { display:none; }
.toggle-switch .slider { width:50px; height:24px; background:#ccc; border-radius:34px; margin-right:8px; position:relative; transition:0.3s; }
.toggle-switch .slider::before { content:""; position:absolute; width:20px; height:20px; left:2px; bottom:2px; background:white; border-radius:50%; transition:0.3s; }
.toggle-switch input:checked + .slider { background:#7354f3; }
.toggle-switch input:checked + .slider::before { transform:translateX(26px); }
.label-text { font-weight:500; font-size:0.9rem; white-space:nowrap; }

/* Tabla estilo lista de inscritos */
.table-responsive { overflow-x:auto; }
.asistencias-table {
    width:100%;
    border-collapse:collapse;
    table-layout:auto;
    font-size:0.9rem;
    min-width:600px;
}
.asistencias-table th, .asistencias-table td {
    border:1px solid #ccc;
    padding:12px;
    text-align:center;
    vertical-align:middle;
    word-break:break-word;
}
.asistencias-table th {
    background:#52658c;
    color:#fff;
    font-weight:normal;
}

/* Acciones estilo botones */
.actions { display:flex; justify-content:center; gap:4px; }
.action-btn { padding:6px 10px; font-size:0.9rem; cursor:pointer; border:none; border-radius:6px; background:#e74d3c; color:#fff; }

/* Responsive */
@media(max-width:1024px){
    .asistencias-table { font-size:0.85rem; }
}
@media(max-width:768px){
    .asistencias-table th, .asistencias-table td { padding:8px; font-size:0.82rem; }
}
@media(max-width:480px){
    .asistencias-table { min-width:0; font-size:0.75rem; }
    .asistencias-table th, .asistencias-table td { padding:6px; font-size:0.72rem; }
}
.asistencias-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    flex-wrap:wrap;
    gap:10px;
}

.btn-export-pdf{
    background:linear-gradient(135deg,#3b82f6,#1e40af);
    color:#fff;
    padding:10px 18px;
    border-radius:10px;
    text-decoration:none;
    font-weight:500;
    font-size:0.9rem;
    display:inline-flex;
    align-items:center;
    gap:6px;
    box-shadow:0 6px 14px rgba(0,0,0,0.15);
    transition:all 0.25s ease;
}

.btn-export-pdf:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 22px rgba(0,0,0,0.25);
    background:linear-gradient(135deg,#2563eb,#1e3a8a);
}

</style>
{% endblock %}

{% block extra_js %}
<!-- jQuery y DataTables (CDN) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){

    // Inicializa DataTable con selector de "Mostrar X registros" y sin buscador/flechitas
    const table = $('#asistenciasTable').DataTable({
        searching:false,      // desactiva buscador
        ordering:false,       // desactiva ordenamiento (flechas)
        lengthChange:true,    // activa selector "Mostrar X registros"
        pageLength:10,        // cantidad de filas por p√°gina
        autoWidth:false,      // ancho autom√°tico para mejor responsividad
        language: {
            lengthMenu: "Mostrar _MENU_ registros",
            zeroRecords: "No se encontraron registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_",
            infoEmpty: "No hay registros",
            infoFiltered: "(filtrado de _MAX_ totales)",
            paginate: { first:"Primero", last:"√öltimo", next:"Siguiente", previous:"Anterior" }
        }
    });

    // Confirmar eliminaci√≥n
    document.querySelectorAll('.swal-delete').forEach(form=>{
        form.addEventListener('submit', function(e){
            e.preventDefault();
            Swal.fire({
                title:'¬øEliminar asistencia?',
                text:`Asistencia de ${form.dataset.nombre}`,
                icon:'warning',
                showCancelButton:true,
                confirmButtonText:'S√≠, eliminar',
                cancelButtonText:'Cancelar',
                confirmButtonColor:'#d33'
            }).then(result=>{ if(result.isConfirmed) form.submit(); });
        });
    });

    // Buscador personalizado
    const input = document.getElementById('searchInput');
    const results = document.getElementById('searchResults');
    let delay = null;

    input.addEventListener('keyup', ()=>{
        clearTimeout(delay);
        delay = setTimeout(()=>{
            const q = input.value.trim();
            if(q.length<2){ results.innerHTML=''; return; }

            fetch("{% url 'miepi:buscar_inscrito' %}?q="+encodeURIComponent(q))
            .then(r=>r.json())
            .then(data=>{
                if(!data.length){
                    results.innerHTML=`<p style="margin-top:10px;color:var(--text-muted)">No se encontraron resultados</p>`;
                    return;
                }
                results.innerHTML = data.map(i=>`
                    <div class="card" style="margin-top:12px">
                        <strong>${i.nombre}</strong><br>
                        üìû ${i.telefono}<br>
                        ${i.ya_presente
                            ? '<span style="color:green;font-weight:bold;">Presente</span>'
                            : `<button onclick="marcarAsistencia('${i.codigo}','${i.nombre}')"
                                      style="margin-top:10px;background:#22c55e;color:#fff;
                                      border:none;padding:6px 14px;border-radius:8px;cursor:pointer;">
                                       ‚úì Asisti√≥</button>`}
                    </div>`).join('');
            });
        },300);
    });

    window.marcarAsistencia = function(codigo,nombre){
        fetch("{% url 'miepi:registrar_asistencia' %}", {
            method:"POST",
            credentials:"same-origin",
            headers:{ "X-CSRFToken":"{{ csrf_token }}","Content-Type":"application/x-www-form-urlencoded" },
            body:"codigo="+encodeURIComponent(codigo)
        })
        .then(r=>r.json())
        .then(data=>{
            if(data.ok){
                table.row.add([
                    nombre,
                    data.dia,
                    data.hora,
                    '<span style="color:green;font-weight:bold;">Presente</span>',
                    '‚úì'
                ]).draw();
                Swal.fire({ icon:'success', title:data.msg, timer:1500, showConfirmButton:false });
                input.value=''; results.innerHTML='';
            } else {
                Swal.fire({ icon:'warning', title:data.msg, timer:2000, showConfirmButton:false });
            }
        }).catch(()=> Swal.fire({ icon:'error', title:'Error al registrar' }));
    };

});

function filtrarGenero(genero){
    const url = new URL(window.location.href);
    if(genero) url.searchParams.set('genero',genero);
    else url.searchParams.delete('genero');
    window.location.href = url.toString();
}

// Mensajes con Swal
document.addEventListener('DOMContentLoaded', function () {
    {% if messages %}
        {% for message in messages %}
        Swal.fire({
            icon: "{% if 'success' in message.tags %}success{% elif 'warning' in message.tags %}warning{% else %}error{% endif %}",
            title: "{{ message|escapejs }}",
            timer: 1800,
            showConfirmButton: false
        });
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
